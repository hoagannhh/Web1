    const openProductForm = () => {
      // load imported items each lần mở form để luôn cập nhật(Sẩn phẩm nhập từ kho)
      loadImportedItems();
      // render checkboxes each lần mở của mỗi category
      populateProductSelect();

      // render options each lần mở(Chọn loại)
      populateCategoryControls();

      // Clear check box cho nó trống lại
      document
        .querySelectorAll('input[name="productMainType"]')
        .forEach((r) => (r.checked = false));
      const addChk = document.querySelectorAll(
        '#categoryCheckboxes input[type="checkbox"]'
      );
      addChk.forEach((cb) => (cb.checked = false));

      if (!importedItems.length) {
        alert(
          "Không có sản phẩm trong phiếu nhập (productImport). Vui lòng thêm phiếu nhập trước khi thêm sản phẩm."
        );
        return;
      }

      currentProductImages = [];
      document.getElementById("productForm").reset(); // reset form
      document.getElementById("imagePreview").innerHTML = "";
      // đảm bảo input readonly được xóa giá trị cũ
      document.getElementById("productCode").value = "";
      document.getElementById("productName").value = "";
      document.getElementById("productInventory").value = 0;
      document.getElementById("productFormModal").classList.add("active");
    };

    // khi chọn sản phẩm từ select -> tự set tên, mã và tồn kho
    document.addEventListener("change", function (e) {
      if (e.target && e.target.id === "productSelect") {
        const selVal = e.target.value;
        const item = importedItems.find((it) => it.name === selVal);
        if (item) {
          // chỉ tự điền tên và tồn kho — không ghi đè mã (người dùng có thể nhập thủ công)
          document.getElementById("productName").value = selVal;
          document.getElementById("productInventory").value =
            item.totalQty || 0;
        } else {
          document.getElementById("productName").value = "";
          document.getElementById("productInventory").value = 0;
        }
      }
    });

    const closeProductForm = () => {
      document.getElementById("productFormModal").classList.remove("active");
      currentProductImages = [];
    };

    document.getElementById("imageBox").addEventListener("click", () => {
      document.getElementById("productImageInput").click();
    });

    document
      .getElementById("productImageInput")
      .addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (file) {
          const base64 = await fileToBase64(file);
          currentProductImages.push(base64);

          const img = document.createElement("img");
          img.src = base64;
          img.style.maxWidth = "100px";
          img.style.marginRight = "10px";
          img.style.marginBottom = "10px";
          document.getElementById("imagePreview").appendChild(img);
        }
      });

    document
      .getElementById("addProductBtn")
      .addEventListener("click", openProductForm);
    document
      .getElementById("cancelProductBtn")
      .addEventListener("click", closeProductForm);

    document
      .getElementById("productFormModal")
      .addEventListener("click", function (e) {
        if (e.target === this) closeProductForm();
      });

    document
      .getElementById("productForm")
      .addEventListener("submit", async (e) => {
        e.preventDefault();

        // bắt buộc chọn sản phẩm từ productSelect
        const selectedName = document.getElementById("productSelect").value;
        if (!selectedName) {
          alert("Vui lòng chọn 1 sản phẩm từ phiếu nhập (productImport).");
          return;
        }

        // NEW: lấy main type (radio) + optional checkbox categories
        const mainTypeInput = document.querySelector(
          'input[name="productMainType"]:checked'
        );
        if (!mainTypeInput) {
          alert("Vui lòng chọn Loại chính (Men's / Women's / Unisex).");
          return;
        }
        const mainType = mainTypeInput.value;

        const optionalCats = Array.from(
          document.querySelectorAll(
            '#categoryCheckboxes input[type="checkbox"]:checked'
          )
        ).map((c) => c.value);

        const selectedCats = [mainType, ...optionalCats].filter(Boolean);

        if (currentProductImages.length === 0) {
          alert("Vui lòng chọn hình ảnh sản phẩm");
          return;
        }

        // sử dụng tên đã chọn; mã và tồn kho đã tự điền (mã có thể do user nhập)
        const newProduct = {
          id:
            document.getElementById("productCode").value || `IMP-${Date.now()}`,
          name: selectedName,
          // now store category as array (main + optional)
          category: selectedCats,
          gender: document.getElementById("productGender").value,
          size: document.getElementById("productSize").value,
          color: document.getElementById("productColor").value,
          description: document.getElementById("productDesc").value,
          inventory:
            parseInt(document.getElementById("productInventory").value) || 0,
          img: currentProductImages[0],
          images: currentProductImages,
          "img-represent": currentProductImages[0],
          "img-link-list": currentProductImages,
          status: "Đang hiển thị",
          createdAt: new Date().toISOString(),
        };

        this.allProducts.push(newProduct);
        localStorage.setItem("allProduct", JSON.stringify(this.allProducts));

        console.log("Sản phẩm đã thêm:", newProduct);
        alert("Thêm sản phẩm thành công!");
        closeProductForm();
        this.currentPage = 1;
        this.renderProductTable();
        this.renderPagination();
      });